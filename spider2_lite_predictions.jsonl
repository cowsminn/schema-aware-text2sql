{"instance_id": "local002", "SQL": "WITH DailySales AS (\n  SELECT\n    DATE(order_purchase_timestamp) AS sale_date,\n    SUM(oi.price) AS daily_revenue\n  FROM orders AS o\n  JOIN order_items AS oi\n    ON o.order_id = oi.order_id\n  JOIN products AS p\n    ON oi.product_id = p.product_id\n  JOIN product_category_name_translation AS pt\n    ON p.product_category_name = pt.product_category_name\n  WHERE\n    pt.product_category_name_english = 'toys'\n    AND o.order_purchase_timestamp BETWEEN '2017-01-01' AND '2018-08-29'\n  GROUP BY\n    DATE(order_purchase_timestamp)\n), RegressionCoefficients AS (\n  SELECT\n    (\n      COUNT(*) * SUM(CAST(strftime('%J', sale_date) AS REAL) * daily_revenue) - SUM(CAST(strftime('%J', sale_date) AS REAL)) * SUM(daily_revenue)\n    ) / (\n      COUNT(*) * SUM(CAST(strftime('%J', sale_date) AS REAL) * CAST(strftime('%J', sale_date) AS REAL)) - SUM(CAST(strftime('%J', sale_date) AS REAL)) * SUM(CAST(strftime('%J', sale_date) AS REAL))\n    ) AS slope,\n    (\n      SUM(daily_revenue) - (\n        (\n          COUNT(*) * SUM(CAST(strftime('%J', sale_date) AS REAL) * daily_revenue) - SUM(CAST(strftime('%J', sale_date) AS REAL)) * SUM(daily_revenue)\n        ) / (\n          COUNT(*) * SUM(CAST(strftime('%J', sale_date) AS REAL) * CAST(strftime('%J', sale_date) AS REAL)) - SUM(CAST(strftime('%J', sale_date) AS REAL)) * SUM(CAST(strftime('%J', sale_date) AS REAL))\n        )\n      ) * SUM(CAST(strftime('%J', sale_date) AS REAL))\n    ) / COUNT(*) AS intercept\n  FROM DailySales\n), PredictedSales AS (\n  SELECT\n    DATE('2018-12-05', '+' || (\n      ROW_NUMBER() OVER () - 1\n    ) || ' days') AS predicted_date,\n    (\n      SELECT\n        slope\n      FROM RegressionCoefficients\n    ) * CAST(strftime('%J', DATE('2018-12-05', '+' || (\n      ROW_NUMBER() OVER () - 1\n    ) || ' days')) AS REAL) + (\n      SELECT\n        intercept\n      FROM RegressionCoefficients\n    ) AS predicted_revenue\n  FROM (\n    SELECT\n      1\n    UNION ALL\n    SELECT\n      1\n    UNION ALL\n    SELECT\n      1\n    UNION ALL\n    SELECT\n      1\n  )\n), MovingAverages AS (\n  SELECT\n    predicted_date,\n    AVG(predicted_revenue) OVER (ORDER BY predicted_date ASC ROWS BETWEEN 2 PRECEDING AND 2 FOLLOWING) AS moving_average\n  FROM PredictedSales\n), FinalResult AS (\n  SELECT\n    SUM(moving_average) AS total_moving_average_sum\n  FROM MovingAverages\n)\nSELECT\n  total_moving_average_sum\nFROM FinalResult;"}
{"instance_id": "local003", "SQL": "WITH CustomerOrderTotals AS (\n  SELECT\n    c.customer_unique_id,\n    o.order_id,\n    SUM(oi.price + oi.freight_value) AS total_spend\n  FROM customers AS c\n  JOIN orders AS o\n    ON c.customer_id = o.customer_id\n  JOIN order_items AS oi\n    ON o.order_id = oi.order_id\n  WHERE\n    o.order_status = 'delivered'\n  GROUP BY\n    c.customer_unique_id,\n    o.order_id\n), CustomerRFM AS (\n  SELECT\n    customer_unique_id,\n    COUNT(order_id) AS Frequency,\n    SUM(total_spend) AS MonetaryValue,\n    MAX(order_purchase_timestamp) AS last_purchase_date\n  FROM CustomerOrderTotals\n  JOIN orders\n    ON CustomerOrderTotals.order_id = orders.order_id\n  GROUP BY\n    customer_unique_id\n), RFM_Scores AS (\n  SELECT\n    customer_unique_id,\n    Frequency,\n    MonetaryValue,\n    last_purchase_date,\n    DATE('now') AS analysis_date,\n    JULIANDAY(DATE('now')) - JULIANDAY(last_purchase_date) AS Recency,\n    NTILE(5) OVER (ORDER BY JULIANDAY(DATE('now')) - JULIANDAY(last_purchase_date) DESC) AS R_Score,\n    NTILE(5) OVER (ORDER BY COUNT(customer_unique_id) OVER (PARTITION BY customer_unique_id)) AS F_Score,\n    NTILE(5) OVER (ORDER BY SUM(MonetaryValue) OVER (PARTITION BY customer_unique_id)) AS M_Score\n  FROM CustomerRFM\n), RFM_Segments AS (\n  SELECT\n    customer_unique_id,\n    R_Score,\n    F_Score,\n    M_Score,\n    CAST(R_Score AS TEXT) || CAST(F_Score AS TEXT) || CAST(M_Score AS TEXT) AS RFM_Segment\n  FROM RFM_Scores\n)\nSELECT\n  RFM_Segment,\n  COUNT(DISTINCT r.customer_unique_id) AS num_customers,\n  SUM(MonetaryValue) / SUM(Frequency) AS avg_sales_per_order\nFROM RFM_Segments AS r\nJOIN CustomerRFM AS c\n  ON r.customer_unique_id = c.customer_unique_id\nGROUP BY\n  RFM_Segment\nORDER BY\n  RFM_Segment;"}
{"instance_id": "local004", "SQL": "WITH CustomerOrderPayments AS (\n  SELECT\n    c.customer_unique_id,\n    o.order_id,\n    o.order_purchase_timestamp,\n    SUM(op.payment_value) AS total_payment\n  FROM customers AS c\n  JOIN orders AS o\n    ON c.customer_id = o.customer_id\n  JOIN order_payments AS op\n    ON o.order_id = op.order_id\n  GROUP BY\n    c.customer_unique_id,\n    o.order_id,\n    o.order_purchase_timestamp\n), CustomerAverages AS (\n  SELECT\n    customer_unique_id,\n    COUNT(order_id) AS total_orders,\n    AVG(total_payment) AS average_payment,\n    MIN(order_purchase_timestamp) AS first_purchase,\n    MAX(order_purchase_timestamp) AS last_purchase\n  FROM CustomerOrderPayments\n  GROUP BY\n    customer_unique_id\n), TopCustomers AS (\n  SELECT\n    customer_unique_id,\n    total_orders,\n    average_payment,\n    first_purchase,\n    last_purchase,\n    NTILE(100) OVER (ORDER BY average_payment DESC) AS customer_rank\n  FROM CustomerAverages\n  ORDER BY\n    average_payment DESC\n  LIMIT 3\n)\nSELECT\n  customer_unique_id,\n  total_orders,\n  average_payment,\n  CASE\n    WHEN CAST(JULIANDAY(last_purchase) - JULIANDAY(first_purchase) AS REAL) / 7 < 1\n    THEN 1.0\n    ELSE CAST(JULIANDAY(last_purchase) - JULIANDAY(first_purchase) AS REAL) / 7\n  END AS customer_lifespan_weeks\nFROM TopCustomers;"}
{"instance_id": "local007", "SQL": "SELECT\n  CAST(AVG(\n    ROUND(\n      ABS(\n        STRFTIME('%J', final_game) - STRFTIME('%J', debut)\n      ) / 365.25,\n      2\n    )\n  ) AS REAL)\nFROM player\nWHERE\n  debut IS NOT NULL AND final_game IS NOT NULL;"}
{"instance_id": "local008", "SQL": "WITH PlayerStats AS (\n  SELECT\n    p.name_given,\n    b.player_id,\n    SUM(b.g) AS total_games_played,\n    SUM(b.r) AS total_runs,\n    SUM(b.h) AS total_hits,\n    SUM(b.hr) AS total_home_runs\n  FROM batting AS b\n  JOIN player AS p\n    ON b.player_id = p.player_id\n  GROUP BY\n    p.name_given,\n    b.player_id\n), RankedStats AS (\n  SELECT\n    name_given,\n    player_id,\n    total_games_played,\n    NTILE(100) OVER (ORDER BY total_games_played DESC) AS games_played_rank,\n    total_runs,\n    NTILE(100) OVER (ORDER BY total_runs DESC) AS runs_rank,\n    total_hits,\n    NTILE(100) OVER (ORDER BY total_hits DESC) AS hits_rank,\n    total_home_runs,\n    NTILE(100) OVER (ORDER BY total_home_runs DESC) AS home_runs_rank\n  FROM PlayerStats\n)\nSELECT\n  name_given,\n  player_id,\n  total_games_played,\n  games_played_rank,\n  total_runs,\n  runs_rank,\n  total_hits,\n  hits_rank,\n  total_home_runs,\n  home_runs_rank\nFROM RankedStats\nWHERE\n  games_played_rank = 100 OR runs_rank = 100 OR hits_rank = 100 OR home_runs_rank = 100;"}
